name: Check err pods on private clusters

on:
  push:
    branches:
      - master

jobs:
  check_pods:
    runs-on: self-hosted
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Check crashed pods on k3s cluster
        run: |
          
          crashed_pods_count=$(kubectl get pods -A --context='k3s' | awk 'NR!=1 {print $4}' | grep -v 'Running' | wc -l)
          crashed_pods_list=$(kubectl get pods -A --context='k3s' | awk 'NR!=1 && $4 != "Running" {print $1"/"$2}')
          echo "Crashed pods in k3s: $crashed_pods_count"
          echo "$crashed_pods_list"
          if [ "$crashed_pods_count" -ne 0 ]; then
            # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã –Ω–∞ \n –¥–ª—è JSON –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏
            message="üö® $crashed_pods_count crashed pods in k3s cluster:\n$(echo "$crashed_pods_list" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')"
            curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$message\"}" "$SLACK_WEBHOOK_URL"
          fi
